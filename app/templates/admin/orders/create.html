{% extends "admin/base.html" %}

{% block admin_title %}新增訂單 - 管理後台{% endblock %}

{% block admin_extra_css %}
<style>
    .motorcycle-search {
        position: relative;
    }
    .search-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-radius: 5px;
        max-height: 300px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .search-result-item {
        padding: 10px;
        cursor: pointer;
        border-bottom: 1px solid #eee;
    }
    .search-result-item:hover {
        background: #f5f5f5;
    }
    .selected-motorcycles {
        margin-top: 10px;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
    }
    .selected-motorcycle {
        display: inline-flex;
        align-items: center;
        padding: 5px 10px;
        background: #e3f2fd;
        border-radius: 5px;
        gap: 5px;
    }
    .model-counts {
        margin-top: 10px;
        padding: 15px;
        background: #f5f5f5;
        border-radius: 5px;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="mb-0">新增訂單</h1>
    <a href="{{ url_for('admin_orders.index') }}" class="btn btn-link text-decoration-none">
        <i class="bi bi-arrow-left me-1"></i>返回
    </a>
</div>

<div class="card">
    <div class="card-body">
        <form method="POST" id="orderForm">
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="partner_id" class="form-label">合作商</label>
                <select class="form-select" id="partner_id" name="partner_id">
                    <option value="">選擇合作商</option>
                    {% for partner in partners %}
                    <option value="{{ partner.id }}">{{ partner.name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="col-md-6 mb-3">
                <label for="renter_id" class="form-label">承租人（舊欄位，選填）</label>
                <input type="text" class="form-control" id="renter_id" name="renter_id" placeholder="保留向後兼容">
            </div>
        </div>
        
        <hr>
        <h5 class="mb-3">承租人資訊</h5>
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="renter_name" class="form-label">承租人姓名</label>
                <input type="text" class="form-control" id="renter_name" name="renter_name" placeholder="請輸入姓名">
            </div>
            
            <div class="col-md-6 mb-3">
                <label for="renter_id_number" class="form-label">身份證號碼</label>
                <input type="text" class="form-control" id="renter_id_number" name="renter_id_number" 
                       placeholder="請輸入身份證號碼（例：A123456789）" 
                       maxlength="10"
                       style="text-transform: uppercase;"
                       oninput="this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '').substring(0, 10);">
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">是否有駕照</label>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="has_license" id="has_license_yes" value="true">
                    <label class="form-check-label" for="has_license_yes">有</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="has_license" id="has_license_no" value="false">
                    <label class="form-check-label" for="has_license_no">沒有</label>
                </div>
            </div>
        </div>
        
        <hr>
        
        <div class="mb-3">
            <label for="rental_motorcycle" class="form-label">租借機車 <span class="text-danger">*</span></label>
            <div class="motorcycle-search">
                <input type="text" class="form-control" id="motorcycle_search" placeholder="輸入車牌號碼搜尋" autocomplete="off">
                <div id="search_results" class="search-results"></div>
            </div>
            <div id="selected_motorcycles" class="selected-motorcycles"></div>
            <div id="model_counts" class="model-counts" style="display: none;">
                <strong>機車統計：</strong>
                <div id="counts_display"></div>
                <div>總台數: <span id="total_count">0</span></div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-4 mb-3">
                <label for="reservation_date" class="form-label">預約日期 <span class="text-danger">*</span></label>
                <input type="date" class="form-control" id="reservation_date" name="reservation_date" required>
            </div>
            
            <div class="col-md-4 mb-3">
                <label for="rental_start_time" class="form-label">租借開始時間</label>
                <input type="datetime-local" class="form-control" id="rental_start_time" name="rental_start_time">
            </div>
            
            <div class="col-md-4 mb-3">
                <label for="rental_end_time" class="form-label">租借結束時間</label>
                <input type="datetime-local" class="form-control" id="rental_end_time" name="rental_end_time">
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="status" class="form-label">狀態 <span class="text-danger">*</span></label>
                <select class="form-select" id="status" name="status" required>
                    <option value="待處理">待處理</option>
                    <option value="進行中">進行中</option>
                    <option value="已完成">已完成</option>
                    <option value="已取消">已取消</option>
                </select>
            </div>
            
            <div class="col-md-6 mb-3">
                <label for="total_amount" class="form-label">總金額 <span class="text-danger">*</span></label>
                <input type="number" class="form-control" id="total_amount" name="total_amount" step="0.01" required>
            </div>
        </div>
        
        <hr class="my-4">
        <h5 class="mb-3">其他選項（非必填）</h5>
        
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="shipping_company" class="form-label">航運公司</label>
                <select class="form-select" id="shipping_company" name="shipping_company">
                    <option value="">選擇航運公司</option>
                    <option value="泰富">泰富</option>
                    <option value="藍白">藍白</option>
                    <option value="聯營">聯營</option>
                    <option value="大福">大福</option>
                </select>
            </div>
            
            <div class="col-md-6 mb-3">
                <label for="contact_phone" class="form-label">聯絡電話</label>
                <input type="text" class="form-control" id="contact_phone" name="contact_phone">
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="ferry_departure_time" class="form-label">船班出發時間</label>
                <input type="datetime-local" class="form-control" id="ferry_departure_time" name="ferry_departure_time">
            </div>
            
            <div class="col-md-6 mb-3">
                <label for="ferry_return_time" class="form-label">船班回程時間</label>
                <input type="datetime-local" class="form-control" id="ferry_return_time" name="ferry_return_time">
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="payment_method" class="form-label">付款方式</label>
                <select class="form-select" id="payment_method" name="payment_method">
                    <option value="">選擇付款方式</option>
                    <option value="現金">現金</option>
                    <option value="月結">月結</option>
                    <option value="日結">日結</option>
                </select>
            </div>
            
            <div class="col-md-6 mb-3">
                <label for="estimated_return_time" class="form-label">預計還車時間</label>
                <input type="datetime-local" class="form-control" id="estimated_return_time" name="estimated_return_time">
            </div>
        </div>
        
        <div class="mb-3">
            <label for="remarks" class="form-label">備註</label>
            <textarea class="form-control" id="remarks" name="remarks" rows="3"></textarea>
        </div>
        
        <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-check-circle me-1"></i>儲存
            </button>
            <a href="{{ url_for('admin_orders.index') }}" class="btn btn-secondary">
                <i class="bi bi-x-circle me-1"></i>取消
            </a>
        </div>
        </form>
    </div>
</div>
{% endblock %}

{% block admin_extra_js %}
<script>
let selectedMotorcycles = [];
let searchTimeout;

$('#motorcycle_search').on('input', function() {
    const query = $(this).val().trim();
    const resultsDiv = $('#search_results');
    
    if (query.length < 2) {
        resultsDiv.hide();
        return;
    }
    
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        $.get(`{{ url_for('admin_orders.search_motorcycles') }}?q=${encodeURIComponent(query)}`)
            .done(function(data) {
                resultsDiv.empty();
                if (data.length === 0) {
                    resultsDiv.html('<div class="search-result-item">無結果</div>');
                } else {
                    data.forEach(function(motorcycle) {
                        if (!selectedMotorcycles.find(m => m.id === motorcycle.id)) {
                            const item = $('<div>').addClass('search-result-item')
                                .text(`${motorcycle.license_plate} - ${motorcycle.model} (${motorcycle.vehicle_type})`)
                                .on('click', function() {
                                    addMotorcycle(motorcycle);
                                });
                            resultsDiv.append(item);
                        }
                    });
                }
                resultsDiv.show();
            });
    }, 300);
});

function addMotorcycle(motorcycle) {
    if (!selectedMotorcycles.find(m => m.id === motorcycle.id)) {
        selectedMotorcycles.push(motorcycle);
        updateSelectedMotorcycles();
        $('#motorcycle_search').val('');
        $('#search_results').hide();
    }
}

function removeMotorcycle(id) {
    selectedMotorcycles = selectedMotorcycles.filter(m => m.id !== id);
    updateSelectedMotorcycles();
}

function updateSelectedMotorcycles() {
    const container = $('#selected_motorcycles');
    container.empty();
    
    selectedMotorcycles.forEach(function(motorcycle) {
        const div = $('<div>').addClass('selected-motorcycle')
            .html(`${motorcycle.license_plate} <button type="button" class="btn-close" onclick="removeMotorcycle(${motorcycle.id})"></button>`);
        container.append(div);
        
        const hiddenInput = $('<input>').attr({
            type: 'hidden',
            name: 'motorcycle_ids',
            value: motorcycle.id
        });
        container.append(hiddenInput);
    });
    
    updateModelCounts();
}

function updateModelCounts() {
    const counts = {};
    selectedMotorcycles.forEach(function(m) {
        counts[m.model] = (counts[m.model] || 0) + 1;
    });
    
    const countsDiv = $('#counts_display');
    const totalSpan = $('#total_count');
    const modelCountsDiv = $('#model_counts');
    
    if (selectedMotorcycles.length === 0) {
        modelCountsDiv.hide();
        return;
    }
    
    modelCountsDiv.show();
    countsDiv.html(Object.entries(counts).map(([model, count]) => 
        `${model}: ${count}台`
    ).join(', '));
    totalSpan.text(selectedMotorcycles.length);
}

// Close search results when clicking outside
$(document).on('click', function(e) {
    if (!$(e.target).closest('.motorcycle-search').length) {
        $('#search_results').hide();
    }
});
</script>
{% endblock %}
